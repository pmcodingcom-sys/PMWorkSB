<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PMCoding Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .page.active { display: block; }
        /* Loader Animation */
        .loader { border-top-color: #4f46e5; animation: spinner 0.8s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased overflow-x-hidden">

    <div id="global-loader" class="fixed inset-0 z-[100] bg-white/90 flex flex-col items-center justify-center hidden">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-2"></div>
        <p class="text-sm text-gray-500 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <header id="public-header" class="fixed top-0 w-full bg-white/80 backdrop-blur-md border-b border-gray-100 z-40 px-6 py-4 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold">P</div>
            <span class="font-bold text-lg text-slate-800">PMCoding</span>
        </div>
        <button onclick="navTo('login')" class="px-5 py-2 bg-indigo-600 text-white rounded-full text-sm font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
    </header>

    <div class="flex min-h-screen pt-16 md:pt-0"> <aside id="app-sidebar" class="hidden flex-col w-64 bg-slate-900 text-white fixed h-full z-50 transition-transform">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-xl font-bold bg-gradient-to-r from-orange-400 to-amber-500 bg-clip-text text-transparent">PMCoding LMS</h1>
                <p class="text-[10px] text-slate-400 mt-1">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <span id="user-name-display">User</span></p>
            </div>
            <nav class="flex-1 px-4 space-y-2 mt-4">
                <button onclick="navTo('home')" class="w-full text-left p-3 rounded-xl hover:bg-slate-800 transition flex gap-3 items-center">
                    <span>üè†</span> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
                <button onclick="navTo('my-courses')" class="w-full text-left p-3 rounded-xl hover:bg-slate-800 transition flex gap-3 items-center">
                    <span>üìö</span> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                <div id="admin-menu" class="hidden mt-4 pt-4 border-t border-slate-800">
                    <p class="px-3 text-[10px] uppercase text-slate-500 mb-2">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <button onclick="alert('‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Coming Soon)')" class="w-full text-left p-3 rounded-xl hover:bg-slate-800 transition flex gap-3 items-center">
                        <span>‚öôÔ∏è</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button onclick="handleLogout()" class="w-full p-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </aside>

        <main id="main-content" class="flex-1 p-4 md:p-8 w-full transition-all duration-300">
            
            <section id="page-home" class="page active max-w-5xl mx-auto">
                <div id="hero-section" class="mb-10 text-center py-10">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-900 mb-4">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</h1>
                    <p class="text-slate-500 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                    <div class="h-1 w-20 bg-orange-500 mx-auto rounded-full"></div>
                </div>

                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-xl font-bold text-slate-800">üî• ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                </div>

                <div id="course-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                    </div>
            </section>

            <section id="page-login" class="page max-w-md mx-auto mt-10">
    <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-gray-100 text-center relative overflow-hidden">
        
        <div id="login-mode" class="transition-all duration-300">
            <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üîê</div>
            <h2 class="text-2xl font-bold mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <p class="text-gray-400 text-sm mb-6">‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="login-email" required class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="user@example.com">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="login-password" required class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </form>
            <p class="mt-6 text-sm text-gray-500">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button onclick="toggleAuthMode('register')" class="text-indigo-600 font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
            </p>
        </div>

        <div id="register-mode" class="hidden transition-all duration-300">
            <div class="w-16 h-16 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üìù</div>
            <h2 class="text-2xl font-bold mb-2">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
            <p class="text-gray-400 text-sm mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</p>
            
            <form id="register-form" class="space-y-4 text-left">
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="text-xs font-bold text-gray-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input type="text" id="reg-name" required class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
        </div>
        <div>
            <label class="text-xs font-bold text-gray-500 ml-1">Line ID</label>
            <input type="text" id="reg-line" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="line1234">
        </div>
    </div>
    
    <div>
        <label class="text-xs font-bold text-gray-500 ml-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" id="reg-email" required class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="your@email.com">
    </div>
    <div>
        <label class="text-xs font-bold text-gray-500 ml-1">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)</label>
        <input type="password" id="reg-password" required minlength="6" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button type="submit" class="w-full py-3 bg-orange-500 text-white rounded-xl font-bold shadow-lg shadow-orange-200 hover:bg-orange-600 active:scale-95 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
</form>
            <p class="mt-6 text-sm text-gray-500">
                ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <button onclick="toggleAuthMode('login')" class="text-indigo-600 font-bold hover:underline">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </p>
        </div>

        <button onclick="navTo('home')" class="mt-6 text-sm text-gray-400 hover:text-gray-600 underline">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
</section>

            <section id="page-my-courses" class="page max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-indigo-600">üìö</span> ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </h2>
                <div id="my-course-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                <button onclick="navTo('home')" class="mt-8 px-6 py-2 bg-gray-200 rounded-full text-sm font-bold text-gray-600">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏∑‡πà‡∏ô</button>
            </section>

        </main>
    </div>

    <nav id="mobile-nav" class="hidden md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 h-16 flex items-center justify-around z-50 px-4 pb-safe shadow-2xl">
        <button onclick="navTo('home')" class="flex flex-col items-center gap-1 text-slate-400 focus:text-indigo-600">
            <span class="text-lg">üè†</span><span class="text-[10px]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </button>
        <button onclick="navTo('my-courses')" class="flex flex-col items-center gap-1 text-slate-400 focus:text-indigo-600">
            <span class="text-lg">üéì</span><span class="text-[10px]">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
        </button>
        <button onclick="handleLogout()" class="flex flex-col items-center gap-1 text-red-300 focus:text-red-500">
            <span class="text-lg">üö™</span><span class="text-[10px]">‡∏≠‡∏≠‡∏Å</span>
        </button>
    </nav>

<div id="payment-modal" class="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl animate-bounce-in">
            <div class="bg-indigo-600 p-6 text-white text-center relative">
                <button onclick="toggleModal('payment-modal', false)" class="absolute top-4 right-4 text-indigo-200 hover:text-white">‚úï</button>
                <h3 class="text-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <p class="text-indigo-100 text-sm mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ</p>
            </div>
            
            <div class="p-6">
                <div class="flex justify-between items-center mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div>
                        <p class="text-xs text-gray-500">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                        <h4 id="pay-course-title" class="font-bold text-slate-800">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤...</h4>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</p>
                        <p id="pay-course-price" class="text-xl font-bold text-orange-500">‡∏ø0</p>
                    </div>
                </div>

                <div class="mb-6 text-center space-y-2">
                    <p class="text-sm font-bold text-gray-600">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
                    <div class="flex items-center justify-center gap-3">
                        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xs">SCB</div>
                        <div class="text-left">
                            <p class="font-bold text-slate-800">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</p>
                            <p class="text-sm text-slate-500">123-456-7890 (‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏™‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)</p>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="file" id="slip-file" accept="image/*" class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-xs file:font-semibold
                        file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100
                    "/>
                    <p class="text-[10px] text-gray-400 mt-1">*‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .jpg, .png</p>
                </div>

                <button onclick="submitPayment()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition">
                    ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                </button>
            </div>
        </div>
    </div>
	
    <script>
        // --- CONFIGURATION ---
        // ‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const SUPABASE_URL = 'https://bibygpupfqmbbwecqgdb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpYnlncHVwZnFtYmJ3ZWNxZ2RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTQ4NDQsImV4cCI6MjA4NTgzMDg0NH0.AL-c_UbvMzsy1DIZFuABStYNeXK2A-r_0uWg26-ET2A';
        
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Library
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
		let selectedCourseId = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏´‡∏ô
		
        // --- AUTH & STATE MANAGEMENT ---
        async function checkSession() {
            toggleLoader(true);
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                updateUI(true);
				fetchUserProfile(); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
            } else {
                updateUI(false);
            }
            toggleLoader(false);
        }

        function updateUI(isLoggedIn) {
    const publicHeader = document.getElementById('public-header');
    const sidebar = document.getElementById('app-sidebar');
    const mobileNav = document.getElementById('mobile-nav');
    const mainContent = document.getElementById('main-content');
    const heroSection = document.getElementById('hero-section');
    const userNameDisplay = document.getElementById('user-name-display');

    if (isLoggedIn) {
        // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ---
        
        // 1. ‡∏ã‡πà‡∏≠‡∏ô Header ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞
        publicHeader.classList.add('hidden');
        
        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Sidebar (‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡πâ‡∏≤‡∏á)
        // ‡∏•‡∏ö class hidden ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å
        sidebar.classList.remove('hidden');
        // ‡πÉ‡∏™‡πà class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏° (md:flex) ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (hidden)
        sidebar.classList.add('hidden', 'md:flex'); 
        
        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Mobile Nav (‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πà‡∏≤‡∏á)
        mobileNav.classList.remove('hidden');
        // ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (flex) ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏° (md:hidden)
        mobileNav.classList.add('flex', 'md:hidden');

        // 4. ‡∏ã‡πà‡∏≠‡∏ô Hero Banner
        if(heroSection) heroSection.classList.add('hidden');
        
        // 5. ‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡∏µ Sidebar (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°)
        mainContent.classList.add('md:ml-64');

        // 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if(userNameDisplay && currentUser) {
            userNameDisplay.innerText = currentUser.email.split('@')[0];
        }

    } else {
        // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
        publicHeader.classList.remove('hidden');
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        sidebar.classList.add('hidden');
        sidebar.classList.remove('md:flex'); // ‡πÄ‡∏≠‡∏≤ flex ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó
        
        mobileNav.classList.add('hidden');
        mobileNav.classList.remove('flex');

        if(heroSection) heroSection.classList.remove('hidden');
        mainContent.classList.remove('md:ml-64');
    }
}

        // --- PAGE NAVIGATION ---
        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            window.scrollTo(0,0);

            if(pageId === 'my-courses') fetchMyCourses();
        }

        // --- DATA FUNCTIONS ---
        async function fetchCourses() {
            toggleLoader(true);
            const { data, error } = await supabaseClient
                .from('courses')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                toggleLoader(false);
                return;
            }

            const container = document.getElementById('course-list');
            container.innerHTML = data.map(course => `
                <div class="bg-white rounded-[1.5rem] overflow-hidden border border-gray-100 shadow-sm hover:shadow-xl transition-all duration-300 group">
                    <div class="relative h-48 overflow-hidden">
                        <img src="${course.image_url}" 
                             onerror="this.src='https://placehold.co/600x400/4f46e5/white?text=PMCoding';" 
                             class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                    
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-slate-800 leading-tight">${course.title}</h3>
                            <span class="bg-orange-100 text-orange-600 text-xs font-bold px-2 py-1 rounded-lg shrink-0 ml-2">
                                ‡∏ø${course.price.toLocaleString()}
                            </span>
                        </div>
                        
                        <p class="text-xs text-gray-500 mb-4 line-clamp-2">${course.description || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...'}</p>
                        
                        <div class="flex items-center justify-between mt-4">
                            <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded">üë®‚Äçüè´ ${course.instructor}</span>
                            
                            <button onclick="handleRegister(${course.id}, '${course.title}', ${course.price})" 
                                    class="px-4 py-2 bg-slate-900 text-white text-xs font-bold rounded-full hover:bg-orange-500 transition shadow-lg">
                                ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            toggleLoader(false);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
        function handleRegister(courseId, title, price) {
            
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏¢‡∏±‡∏á?
            if (!currentUser) {
                if(confirm('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    navTo('login');
                }
                return;
            }

            // 2. ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏á‡πÑ‡∏ß‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)
            selectedCourseId = courseId;

            // 3. ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô Modal
            document.getElementById('pay-course-title').innerText = title;
            document.getElementById('pay-course-price').innerText = '‡∏ø' + price.toLocaleString();
            
            // 4. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            document.getElementById('slip-file').value = '';

            // 5. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ (‡∏à‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ)
            toggleModal('payment-modal', true);
        }

        async function fetchMyCourses() {
            if(!currentUser) return;
            toggleLoader(true);
            
            // Join ‡∏ï‡∏≤‡∏£‡∏≤‡∏á registrations ‡∏Å‡∏±‡∏ö courses
            const { data, error } = await supabaseClient
                .from('registrations')
                .select('registered_at, courses(*)')
                .eq('user_id', currentUser.id);

            const container = document.getElementById('my-course-list');
            
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 bg-white rounded-2xl border border-dashed border-gray-300">
                    <p class="text-gray-400">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏î‡πÜ</p>
                    <button onclick="navTo('home')" class="mt-2 text-indigo-600 font-bold text-sm">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </div>`;
            } else {
                container.innerHTML = data.map(item => `
                    <div class="flex bg-white p-4 rounded-2xl shadow-sm border border-gray-100 gap-4 items-center">
                        <img src="${item.courses.image_url}" class="w-20 h-20 rounded-xl object-cover bg-gray-200">
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">${item.courses.title}</h4>
                            <p class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${item.courses.instructor}</p>
                            <p class="text-[10px] text-gray-400 mt-1">‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(item.registered_at).toLocaleDateString('th-TH')}</p>
                        </div>
                        <span class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full">Active</span>
                    </div>
                `).join('');
            }
            toggleLoader(false);
        }

        // --- AUTH ACTION (LOGIN & REGISTER) ---
        
        // 1. ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Login <-> Register
        function toggleAuthMode(mode) {
            const loginMode = document.getElementById('login-mode');
            const regMode = document.getElementById('register-mode');
            
            if (mode === 'register') {
                loginMode.classList.add('hidden');
                regMode.classList.remove('hidden');
            } else {
                regMode.classList.add('hidden');
                loginMode.classList.remove('hidden');
            }
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            toggleLoader(true);
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                alert('‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
                toggleLoader(false);
            } else {
                currentUser = data.user;
                updateUI(true); 
                navTo('home');  
                // alert('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö! üéâ'); // ‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
                toggleLoader(false);
            }
        });

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Register (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡πÄ‡∏ä‡πá‡∏Ñ Error + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Profile)
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const name = document.getElementById('reg-name').value;
            const lineId = document.getElementById('reg-line').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            if (password.length < 6) {
                alert('‚ö†Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            toggleLoader(true);
            
            // 2. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Auth)
            const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
            });

            // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Error Handling ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ---
            if (authError) {
                toggleLoader(false);
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Error ‡∏Ñ‡∏∑‡∏≠ "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (authError.message.includes("User already registered")) {
                    alert('‚ö†Ô∏è ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! \n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ó‡∏ô');
                    toggleAuthMode('login'); // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
                    document.getElementById('login-email').value = email; // ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢
                } else {
                    alert('‚ùå ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + authError.message);
                }
                return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
            // ---------------------------------------------

            // 3. ‡∏ñ‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Auth ‡∏ú‡πà‡∏≤‡∏ô -> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'profiles'
            if (authData.user) {
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert([
                        { 
                            id: authData.user.id,    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Auth ID
                            full_name: name,         // ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
                            line_id: lineId,         // Line ID ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
                            role: 'user'             // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default
                        }
                    ]);

                if (profileError) {
                    console.error("Profile Error:", profileError);
                    alert('‚ö†Ô∏è ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)');
                } else {
                    alert('‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    currentUser = authData.user;
                    // (Optional) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                    if(currentUser) currentUser.user_metadata = { full_name: name }; 
                    
                    updateUI(true);
                    fetchUserProfile(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
                    navTo('home');
                }
            }
            
            toggleLoader(false);
        });

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
async function fetchUserProfile() {
    if(!currentUser) return;
    
    const { data, error } = await supabaseClient
        .from('profiles')
        .select('full_name, line_id')
        .eq('id', currentUser.id)
        .single();

    if (data) {
        const nameDisplay = document.getElementById('user-name-display');
        if(nameDisplay) nameDisplay.innerText = data.full_name || currentUser.email;
    }
}

async function submitPayment() {
    const fileInput = document.getElementById('slip-file');
    const file = fileInput.files[0];

    if (!file) {
        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
        return;
    }

    toggleLoader(true);

    try {
        // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥) -> userId/timestamp.jpg
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

        // 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô Storage Bucket 'slips'
        const { data: uploadData, error: uploadError } = await supabaseClient
            .storage
            .from('slips')
            .upload(fileName, file);

        if (uploadError) throw uploadError;

        // 3. ‡∏Ç‡∏≠ Public URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        const { data: { publicUrl } } = supabaseClient
            .storage
            .from('slips')
            .getPublicUrl(fileName);

        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• registrations
        const { error: dbError } = await supabaseClient
            .from('registrations')
            .insert([
                { 
                    user_id: currentUser.id, 
                    course_id: selectedCourseId,
                    slip_url: publicUrl,
                    status: 'pending' // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                }
            ]);

        if (dbError) {
            if (dbError.code === '23505') throw new Error('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
            throw dbError;
        }

        // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!
        alert('‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
        toggleModal('payment-modal', false);
        navTo('my-courses');

    } catch (error) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
    } finally {
        toggleLoader(false);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î Modal (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏î‡πâ‡∏á)
        function toggleModal(modalID, show) {
            const modal = document.getElementById(modalID);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class flex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
                    modal.classList.add('flex'); 
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            } else {
                console.error('‡πÑ‡∏°‡πà‡∏û‡∏ö Modal ID:', modalID);
            }
        }
		
        async function handleLogout() {
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
                toggleLoader(true);
                await supabaseClient.auth.signOut();
                currentUser = null;
                updateUI(false); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö Public
                navTo('home');
                toggleLoader(false);
            }
        }

        // --- UI UTILS ---
        function toggleLoader(show) {
            document.getElementById('global-loader').classList.toggle('hidden', !show);
        }
		

        // --- INIT ---
        window.onload = () => {
            checkSession();
            fetchCourses();
        };
    </script>
</body>
</html>
